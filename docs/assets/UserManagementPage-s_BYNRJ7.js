import{c as F,e as C,o as b,s as x,J as d,j as e,aN as k,aO as q,B as f,v as E,aP as L,aQ as P,aR as $,aS as I,aT as Q,aU as B,aV as H,aW as K,aX as O,aY as z,aZ as J,a_ as V,a$ as Y,b0 as W,a as X,S as p,b1 as D,b2 as Z,b3 as U,b4 as S,b5 as G,b6 as ee,b7 as _,b8 as j,b9 as se,ba as g,A as ae,g as re,i as le,k as ne,r as m,ak as te,bb as ie,al as oe,am as ce,an as de,ao as ue,w,I as v,u as he,a3 as me}from"./index-D6Dh-tOY.js";import{S as xe}from"./shield-alert-CDJYaQEO.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=F("ShieldCheck",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),ge=["admin","moderator","user"],pe=({userId:n,currentRoles:o})=>{const t=C(),i=b({mutationFn:async({userId:s,role:r})=>{const{error:h}=await x.rpc("add_role_to_user",{p_user_id:s,p_role:r});if(h)throw h},onSuccess:(s,{role:r})=>{d.success(`Role '${r}' added.`),t.invalidateQueries({queryKey:["allUsers"]})},onError:(s,{role:r})=>{d.error(`Failed to add role '${r}'.`,{description:s.message})}}),a=b({mutationFn:async({userId:s,role:r})=>{const{error:h}=await x.rpc("remove_role_from_user",{p_user_id:s,p_role:r});if(h)throw h},onSuccess:(s,{role:r})=>{d.info(`Role '${r}' removed.`),t.invalidateQueries({queryKey:["allUsers"]})},onError:(s,{role:r})=>{d.error(`Failed to remove role '${r}'.`,{description:s.message})}}),l=(s,r)=>{r?i.mutate({userId:n,role:s}):a.mutate({userId:n,role:s})},u=s=>{switch(s){case"admin":return"text-red-400";case"moderator":return"text-yellow-400";case"user":return"text-blue-400";default:return"text-gray-400"}};return e.jsxs(k,{children:[e.jsx(q,{asChild:!0,children:e.jsxs(f,{variant:"outline",className:"w-40 justify-between",children:[e.jsx("span",{children:"Manage Roles"}),e.jsx(E,{})]})}),e.jsxs(L,{className:"w-56",children:[e.jsx(P,{children:"Assign Roles"}),e.jsx($,{}),ge.map(s=>e.jsxs(I,{checked:o.includes(s),onCheckedChange:r=>l(s,!!r),children:[e.jsx(je,{className:`mr-2 h-4 w-4 ${u(s)}`}),e.jsx("span",{children:s.charAt(0).toUpperCase()+s.slice(1)})]},s))]})]})},fe=({userId:n,userName:o,onSuccess:t})=>{const i=b({mutationFn:async a=>{const{error:l}=await x.rpc("delete_app_user",{p_user_id:a});if(l)throw l},onSuccess:()=>{d.success(`User ${o||n} has been deleted.`),t()},onError:a=>{d.error("Failed to delete user.",{description:a.message})}});return e.jsxs(Q,{children:[e.jsx(B,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"icon",className:"text-red-400 hover:text-red-300 hover:bg-red-500/10",children:e.jsx(H,{className:"h-4 w-4"})})}),e.jsxs(K,{children:[e.jsxs(O,{children:[e.jsx(z,{children:"Are you absolutely sure?"}),e.jsxs(J,{children:["This action cannot be undone. This will permanently delete the user account for"," ",e.jsx("span",{className:"font-bold",children:o||n})," and remove their data from our servers."]})]}),e.jsxs(V,{children:[e.jsx(Y,{children:"Cancel"}),e.jsx(W,{onClick:()=>i.mutate(n),disabled:i.isPending,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:i.isPending?"Deleting...":"Yes, delete user"})]})]})]})},we=()=>{const{data:n,isLoading:o,error:t,refetch:i}=X({queryKey:["allUsers"],queryFn:async()=>{const{data:a,error:l}=await x.rpc("get_all_users_with_roles");if(l)throw new Error(l.message);return a}});return o?e.jsx("div",{className:"space-y-2",children:[...Array(5)].map((a,l)=>e.jsx(p,{className:"h-16 w-full"},l))}):t?e.jsxs(D,{variant:"destructive",children:[e.jsx(Z,{className:"h-4 w-4"}),e.jsx(U,{children:"Error"}),e.jsx(S,{children:t.message})]}):e.jsx("div",{className:"border rounded-lg",children:e.jsxs(G,{children:[e.jsx(ee,{children:e.jsxs(_,{children:[e.jsx(j,{children:"User"}),e.jsx(j,{children:"Email"}),e.jsx(j,{children:"Roles"}),e.jsx(j,{className:"text-right",children:"Actions"})]})}),e.jsx(se,{children:n==null?void 0:n.map(a=>{var l,u,s;return e.jsxs(_,{children:[e.jsx(g,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ae,{children:[e.jsx(re,{src:a.avatar_url||""}),e.jsx(le,{children:((l=a.full_name)==null?void 0:l.charAt(0))||((u=a.email)==null?void 0:u.charAt(0))||"U"})]}),e.jsx("span",{children:a.full_name||"N/A"})]})}),e.jsx(g,{children:a.email}),e.jsx(g,{children:e.jsx("div",{className:"flex gap-1 flex-wrap",children:((s=a.roles)==null?void 0:s.length)>0?a.roles.map(r=>e.jsx(ne,{variant:r==="admin"?"default":"secondary",children:r},r)):e.jsx("span",{className:"text-muted-foreground text-sm",children:"No roles"})})}),e.jsx(g,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(pe,{userId:a.user_id,currentRoles:a.roles}),e.jsx(fe,{userId:a.user_id,userName:a.full_name,onSuccess:i})]})})]},a.user_id)})})]})})},ve=({children:n})=>{const[o,t]=m.useState(""),[i,a]=m.useState(""),[l,u]=m.useState(""),[s,r]=m.useState(!1),[h,y]=m.useState(!1),T=C(),N=()=>{t(""),a(""),u("")},M=async c=>{if(c.preventDefault(),l.length<6){d.error("Password should be at least 6 characters.");return}r(!0);const{error:A}=await x.auth.signUp({email:i,password:l,options:{data:{full_name:o}}});r(!1),A?d.error(A.message):(d.success(`Invitation sent to ${i}.`,{description:"The user needs to confirm their account via email."}),T.invalidateQueries({queryKey:["allUsers"]}),y(!1),N())},R=c=>{y(c),c||N()};return e.jsxs(te,{open:h,onOpenChange:R,children:[e.jsx(ie,{asChild:!0,children:n}),e.jsxs(oe,{className:"sm:max-w-[425px]",children:[e.jsxs(ce,{children:[e.jsx(de,{children:"Add New User"}),e.jsx(ue,{children:"Create a new user account. An invitation email will be sent for confirmation."})]}),e.jsxs("form",{onSubmit:M,children:[e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"name",children:"Full Name"}),e.jsx(v,{id:"name",placeholder:"John Doe",value:o,onChange:c=>t(c.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"email-signup",children:"Email"}),e.jsx(v,{id:"email-signup",type:"email",placeholder:"m@example.com",value:i,onChange:c=>a(c.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"password-signup",children:"Password"}),e.jsx(v,{id:"password-signup",type:"password",placeholder:"••••••••",value:l,onChange:c=>u(c.target.value),required:!0})]})]}),e.jsx(f,{type:"submit",className:"w-full",disabled:s,children:s?"Adding User...":"Add User"})]})]})]})},Ne=()=>{const{isAdmin:n,loading:o}=he(),t=()=>o?e.jsxs("div",{className:"space-y-4",children:[e.jsx(p,{className:"h-10 w-1/4"}),e.jsx(p,{className:"h-8 w-1/2"}),e.jsx("div",{className:"space-y-2",children:[...Array(5)].map((i,a)=>e.jsx(p,{className:"h-16 w-full"},a))})]}):n?e.jsx(we,{}):e.jsxs(D,{variant:"destructive",className:"max-w-2xl mx-auto",children:[e.jsx(xe,{className:"h-4 w-4"}),e.jsx(U,{children:"Access Denied"}),e.jsx(S,{children:"You do not have permission to view this page. Administrator access is required."})]});return e.jsx("div",{className:"bg-background text-foreground flex-grow flex flex-col",children:e.jsx("div",{className:"container mx-auto px-4 py-8 flex-grow",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("h1",{className:"text-4xl font-bold",children:"User Management"}),n&&e.jsx(ve,{children:e.jsxs(f,{children:[e.jsx(me,{className:"mr-2 h-4 w-4"}),"Add User"]})})]}),e.jsx("p",{className:"text-muted-foreground mb-8",children:"View, manage roles, delete, and add new users."}),t()]})})})};export{Ne as default};
