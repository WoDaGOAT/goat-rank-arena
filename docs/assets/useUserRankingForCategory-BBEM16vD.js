import{u as _,r as u,s as g,a as C}from"./index-D6Dh-tOY.js";const h=()=>{const{user:o}=_(),t=u.useCallback(()=>{let e=sessionStorage.getItem("analytics_session_id");return e||(e=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,sessionStorage.setItem("analytics_session_id",e)),e},[]),i=u.useCallback(()=>{const e=new URLSearchParams(window.location.search),r=document.referrer;return{source:e.get("utm_source")||l(r),medium:e.get("utm_medium")||null,campaign:e.get("utm_campaign")||null,content:e.get("utm_content")||null,term:e.get("utm_term")||null,referrer:r||null}},[]),l=e=>{if(!e)return"direct";const r=new URL(e).hostname.toLowerCase();return r.includes("facebook.com")||r.includes("fb.com")?"facebook":r.includes("twitter.com")||r.includes("t.co")?"twitter":r.includes("instagram.com")?"instagram":r.includes("linkedin.com")?"linkedin":r.includes("tiktok.com")?"tiktok":r.includes("youtube.com")?"youtube":r.includes("google.com")?"google":r.includes("bing.com")?"bing":r.includes("yahoo.com")?"yahoo":r.includes("googleads.g.doubleclick.net")?"google_ads":r.includes("facebook.com")?"facebook_ads":"referral"},n=u.useCallback(async(e,r={},s)=>{const a=t(),c=i();try{await g.from("analytics_events").insert({event_type:e,user_id:(o==null?void 0:o.id)||null,session_id:a,properties:r,traffic_source:c.source,referrer:c.referrer,utm_source:c.source,utm_medium:c.medium,utm_campaign:c.campaign,utm_content:c.content,utm_term:c.term,ip_address:null,user_agent:navigator.userAgent,page_url:(s==null?void 0:s.pageUrl)||window.location.pathname,previous_page_url:(s==null?void 0:s.previousPageUrl)||null,interaction_type:(s==null?void 0:s.interactionType)||null,form_step:(s==null?void 0:s.formStep)||null,time_spent_seconds:(s==null?void 0:s.timeSpentSeconds)||null}),await g.from("user_sessions").upsert({session_id:a,user_id:(o==null?void 0:o.id)||null,traffic_source:c.source,referrer:c.referrer,utm_source:c.source,utm_medium:c.medium,utm_campaign:c.campaign,page_views:1,user_agent:navigator.userAgent,updated_at:new Date().toISOString()},{onConflict:"session_id"})}catch(S){console.error("Analytics tracking error:",S)}},[o,t,i]),m=u.useCallback((e,r)=>{n("page_view",{page:e,...r},{pageUrl:e,previousPageUrl:sessionStorage.getItem("previous_page_url")||void 0}),sessionStorage.setItem("previous_page_url",e)},[n]),f=u.useCallback(e=>{n("signup",{method:e})},[n]),p=u.useCallback((e,r)=>{n("ranking_created",{categoryId:e,categoryName:r})},[n]),k=u.useCallback((e,r)=>{n("comment_posted",{categoryId:e,rankingId:r})},[n]),b=u.useCallback((e,r)=>{n("quiz_completed",{quizId:e,score:r})},[n]),w=u.useCallback((e,r,s)=>{n(`form_step_${r}`,{step:e},{formStep:e,timeSpentSeconds:s})},[n]),y=u.useCallback((e,r,s)=>{n(`ranking_${r}`,{step:e},{interactionType:"ranking_flow",timeSpentSeconds:s})},[n]);return u.useEffect(()=>{m(window.location.pathname+window.location.search)},[m]),{trackEvent:n,trackPageView:m,trackSignup:f,trackRankingCreated:p,trackCommentPosted:k,trackQuizCompleted:b,trackFormStep:w,trackRankingFlow:y}},v=o=>{const{user:t}=_();return C({queryKey:["userRanking",t==null?void 0:t.id,o],queryFn:async()=>{if(!t||!o)return console.log("useUserRankingForCategory - Missing user or categoryId:",{userId:t==null?void 0:t.id,categoryId:o}),null;console.log("useUserRankingForCategory - Checking ranking for user:",t.id,"category:",o);const{data:i,error:l}=await g.from("user_rankings").select("id").eq("user_id",t.id).eq("category_id",o).maybeSingle();if(l)throw console.error("useUserRankingForCategory - Error:",l),l;return console.log("useUserRankingForCategory - Result:",i),i},enabled:!!t&&!!o})};export{h as a,v as u};
