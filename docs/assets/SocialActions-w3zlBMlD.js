import{u as q,e as F,r as E,a as u,s as d,o as L,J as S,j as s,T as A}from"./index-D6Dh-tOY.js";import{T as K,F as U}from"./ShareDialog-WkeXcJas.js";import{F as I}from"./flame-DVX3-eVT.js";const D=({categoryId:g,rankingId:b})=>{const{user:o,openLoginDialog:m}=q(),y=F(),[w,h]=E.useState(null),i=g?"category":"ranking",t=g||b;console.log("SocialActions rendered:",{itemType:i,itemId:t,userId:o==null?void 0:o.id});const{data:l=null,isLoading:_}=u({queryKey:["userReaction",i,t,o==null?void 0:o.id],queryFn:async()=>{if(!o||!t)return null;console.log("Fetching user reaction for:",{itemType:i,itemId:t,userId:o.id});const r=i==="category"?"category_reactions":"ranking_reactions",{data:e,error:n}=await d.from(r).select("reaction_type").eq(i==="category"?"category_id":"ranking_id",t).eq("user_id",o.id).maybeSingle();if(n)throw console.error("Error fetching user reaction:",n),n;return console.log("User reaction fetched:",(e==null?void 0:e.reaction_type)||"none"),(e==null?void 0:e.reaction_type)||null},enabled:!!o&&!!t}),{data:j={},isLoading:v}=u({queryKey:["reactionCounts",i,t],queryFn:async()=>{if(!t)return{};console.log("Fetching reaction counts for:",{itemType:i,itemId:t});const r=i==="category"?"category_reactions":"ranking_reactions",{data:e,error:n}=await d.from(r).select("reaction_type").eq(i==="category"?"category_id":"ranking_id",t);if(n)throw console.error("Error fetching reaction counts:",n),n;const a={"thumbs-up":0,trophy:0,flame:0,frown:0};return e.forEach(c=>{a[c.reaction_type]=(a[c.reaction_type]||0)+1}),console.log("Reaction counts fetched:",a),a},enabled:!!t}),{data:p=0}=u({queryKey:[i==="category"?"categoryCommentCount":"rankingCommentCount",t],queryFn:async()=>{if(!t)return 0;const r=i==="category"?"category_comments":"ranking_comments",{count:e,error:n}=await d.from(r).select("*",{count:"exact",head:!0}).eq(i==="category"?"category_id":"ranking_id",t);if(n)throw console.error("Error fetching comment count:",n),n;return e||0},enabled:!!t}),{mutate:N,isPending:C}=L({mutationFn:async r=>{if(!o||!t)throw m(),new Error("User not authenticated");console.log("Toggling reaction:",{reactionType:r,itemType:i,itemId:t,userId:o.id,currentReaction:l});const e=i==="category"?"category_reactions":"ranking_reactions",n=i==="category"?"category_id":"ranking_id";if(l===r){console.log("Removing current reaction");const{error:a}=await d.from(e).delete().match({user_id:o.id,[n]:t,reaction_type:r});if(a)throw a}else{if(l){console.log("Removing existing reaction:",l);const{error:c}=await d.from(e).delete().match({user_id:o.id,[n]:t,reaction_type:l});if(c)throw c}console.log("Adding new reaction:",r);const{error:a}=await d.from(e).insert({user_id:o.id,[n]:t,reaction_type:r});if(a)throw a}},onSuccess:()=>{console.log("Reaction toggled successfully, invalidating queries"),y.invalidateQueries({queryKey:["userReaction",i,t,o==null?void 0:o.id]}),y.invalidateQueries({queryKey:["reactionCounts",i,t]})},onError:r=>{console.error("Failed to toggle reaction:",r),r.message!=="User not authenticated"&&S.error("Failed to update reaction. Please try again.")}}),k=r=>{if(!o){console.log("User not authenticated, opening login dialog"),m();return}console.log("Handling reaction click:",r),N(r)},R=[{icon:K,label:"thumbs-up",tooltip:"Great!",emoji:"👍"},{icon:A,label:"trophy",tooltip:"Champion!",emoji:"🏆"},{icon:I,label:"flame",tooltip:"Fire!",emoji:"🔥"},{icon:U,label:"frown",tooltip:"Disagree",emoji:"😔"}],f=_||v||C;return t?s.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4 bg-black/20 rounded-lg p-3 border border-white/10",children:[s.jsx("div",{className:"flex items-center justify-center sm:justify-start gap-2 flex-wrap",children:R.map(({icon:r,label:e,tooltip:n,emoji:a})=>{const c=l===e,x=j[e]||0;return s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsxs("button",{onClick:()=>k(e),onMouseEnter:()=>h(e),onMouseLeave:()=>h(null),disabled:f,className:`relative group p-2 rounded-lg transition-all duration-200 hover:scale-110 border-2 touch-manipulation ${c?e==="thumbs-up"?"bg-blue-500/30 border-blue-400 text-blue-300":e==="trophy"?"bg-yellow-500/30 border-yellow-400 text-yellow-300":e==="flame"?"bg-orange-500/30 border-orange-400 text-orange-300":"bg-red-500/30 border-red-400 text-red-300":"bg-white/10 border-white/20 text-gray-300 hover:bg-white/20 hover:border-white/40 hover:text-white"} ${f?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,title:n,children:[s.jsx(r,{className:"h-3 w-3 sm:h-4 sm:w-4"}),s.jsx("div",{className:`absolute -top-8 left-1/2 transform -translate-x-1/2 bg-black/90 text-white text-xs px-2 py-1 rounded-md whitespace-nowrap transition-opacity duration-200 z-10 ${w===e?"opacity-100":"opacity-0 pointer-events-none"}`,children:n})]}),x>0&&s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:"text-sm sm:text-lg",children:a}),s.jsx("span",{className:`text-xs sm:text-sm font-bold ${c?"text-white":"text-gray-300"}`,children:x})]})]},e)})}),s.jsxs("div",{className:"flex items-center justify-center sm:justify-end gap-2 text-gray-200 bg-white/10 px-3 py-2 rounded-lg border border-white/20",children:[s.jsx("span",{className:"text-sm sm:text-lg",children:"💬"}),s.jsxs("span",{className:"text-xs sm:text-sm font-medium",children:[p," ",p===1?"Comment":"Comments"]})]})]}):(console.error("SocialActions: No itemId provided"),null)};export{D as S};
